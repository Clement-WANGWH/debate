# 增强型多智能体辩论系统

## 系统概述

本系统是一个基于多智能体协作的推理辩论框架，通过双向推理机制和渐进式共识策略来提高问题求解的准确性和可靠性。

## 核心改进

### 1. 双向推理机制
- **前向推理**：从问题出发，逐步推导到答案
- **反向验证**：从答案反推，验证推理链的正确性
- **综合评估**：结合前向和反向结果，生成最终置信度

### 2. 外部记忆管理
- **文件系统存储**：长观察结果自动存储到文件系统
- **可逆压缩**：上下文超过阈值时压缩存储，保留引用
- **失败记录**：完整保存错误信息用于学习改进

### 3. 任务追踪系统
- **动态任务清单**：实时维护任务状态，防止目标偏离
- **状态持久化**：任务进度保存到`memory/tasks.md`
- **上下文注入**：任务状态自动注入到提示词中

### 4. 渐进式共识策略
- **动态阈值**：随轮次递减的共识阈值（0.7→0.4）
- **加权投票**：基于置信度的加权共识判断
- **自适应终止**：根据收敛速度动态调整辩论轮次

### 5. 结构化多样性
- **模板变化**：每轮引入不同的思考角度
- **噪声注入**：渐进增加的结构化噪声
- **格式多样**：保持上下文的多样性，增强鲁棒性

## 快速开始

### 1. 配置环境

```bash
pip install -r requirements.txt
```

### 2. 配置API密钥

```yaml
qwen:
  api_key: "your-api-key"
  model: "qwen-flash"
```

### 3. 运行单次辩论

```python
import asyncio
from enhanced_debate import quick_debate

async def main():
    question = "你的问题"
    result = await quick_debate(question)
    print(f"答案: {result['answer']}")
    print(f"置信度: {result['confidence']}")

asyncio.run(main())
```

### 4. 批量实验

```bash
python main.py --batch data/dataset.jsonl --dataset gsm8k --max-samples 100
```

## 关键特性

### 双向推理流程

1. **假设生成**：基于问题生成初始假设
2. **前向推导**：从假设推导到答案
3. **反向验证**：从答案验证推理链
4. **置信度融合**：综合双向结果

### 记忆管理策略

- **自动压缩**：超过1000字符的内容自动存储
- **引用保留**：压缩内容保留文件引用
- **按需加载**：需要时从文件系统恢复

### 共识达成机制

- **第1轮**：阈值0.7，要求高度一致
- **第2轮**：阈值0.65，适度放宽
- **第3轮**：阈值0.6，继续放宽
- **第4轮+**：阈值降至0.4下限

### 错误学习

系统完整保留所有错误信息：
- 错误类型和堆栈
- 触发错误的上下文
- 时间戳和相关元数据

这些信息用于：
- 改进提示词设计
- 优化重试策略
- 识别系统性问题

## 性能优化

### 并发控制
- 智能体并发执行
- 异步LLM调用
- 批处理优化

### 缓存机制
- 会话级缓存
- 文件系统持久化
- 智能淘汰策略

### 资源管理
- 自动内存清理
- 文件数量控制
- 上下文窗口管理

## 实验评估

系统支持多种评估方式：

1. **自动评估**：集成评估器自动打分
2. **人工评估**：导出结果供人工审核
3. **对比实验**：与基线系统对比

## 最佳实践

1. **问题类型适配**
   - 数学推理：启用完整双向验证
   - 事实问答：侧重前向推理
   - 创意生成：增加结构化多样性

2. **参数调优**
   - 简单问题：2-3轮，3个智能体
   - 复杂问题：4-5轮，5个智能体
   - 开放问题：增加多样性噪声

3. **错误处理**
   - 保留所有错误信息
   - 定期分析错误模式
   - 迭代优化提示词

## 技术细节

### 上下文管理

系统实现了"只增不减"的上下文管理策略：
- 历史记录永不删除
- 通过压缩控制长度
- 保持完整可追溯性

### 任务防偏离

通过任务清单机制防止目标偏离：
- 实时更新任务状态
- 注入最近5个任务上下文
- 定期提醒原始目标

### 多样性保证

每轮注入结构化多样性：
- 10%基础噪声
- 每轮增加5%
- 随机模板变化